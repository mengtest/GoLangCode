---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by soonyo.
--- DateTime: 2019/4/19 11:28
---


----------------------------------------------------------------------------------------------
--- 轮盘的协议
----------------------------------------------------------------------------------------------




---------------------------------------------主协议入口-----------------------------------------------------
-- 客户端轮盘请求
function HandleGameWheel(userId,data)
    local player,game, gameTable = GetPlayer_Game_Table(userId)

    local msg = CMD_Game_TB_pb.CMD_C_GAME_WHEELPLATE()
    msg:ParseFromString(data)
    --print("wheel_num ",msg.wheel_num)

    -- 回复客户端协议
    local sendCmd = CMD_Game_TB_pb.CMD_S_GAME_WHEELPLATE()
    sendCmd.wheel_num = msg.wheel_num         -- 客户端发过来的

    local gold_reward = 0		--//当中奖值

    local rType = ROULETTE_TYPE_WRONG
    local multi = 0   -- 中奖倍率

    -- 是否开启轮盘
    --player.WheelOpen = 1    -- 调试模式
    if player.WheelOpen > 0 then
        player.WheelOpen = 0

        -- 随机出轮盘的类型
        rType, multi = WheelCalcPlateWinPro()

        --rType = ROULETTE_TYPE_STAR      -- 调试，星星

        if rType == ROULETTE_TYPE_STAR then     --如果是星星，中大奖池
            WheelClearGoldReward(player)      -- 奖励保存清空，因为已经发了
            player.m_eRouletteCurType = ROULETTE_TYPE_STAR;

            local get_jackpot_score = JackpotGet(gameTable)

            gold_reward =  math.floor( get_jackpot_score/ gameTable.RoomScore)     -- 大奖池
            gameTable.JackpotLastPlayerName = player.User.NickName
            gameTable.JackpotLastGetScore = get_jackpot_score

            -- 如果是星星， 那么不用猜了， 直接发奖
            sendCmd = WheelCalcCreateCoin_Roulette(gold_reward, player,sendCmd, ROULETTE_TYPE_STAR )

            SqlSaveUserWheelLog(player,"星星", gold_reward, sendCmd.big_coin_data.big_coin_lottery_value)      -- 记录轮盘日志

            SqlSaveSystemLogJackpot(gameTable , "大奖池中奖", get_jackpot_score , userId)      -- 记录大奖池日志
            -- 发送跑马灯消息
            SystemTipSendToAllPlayers(player.User.NickName.." win Jackpot !!! Got ".. get_jackpot_score , 0)        -- 发送跑马灯消息

            -- 重置大奖池
            gameTable.JackpotAll = 0        -- 大奖池清零

        elseif rType > ROULETTE_TYPE_STAR and rType < ROULETTE_TYPE_MAX then
            WheelAddGoldReward(player, multi)           -- 记录当前奖励，用来以后翻倍
            player.m_eRouletteCurType = rType;

            -- 如果是普通中奖，还会有猜红黑
            SqlSaveUserWheelLog(player, "猜中轮盘类型:"..rType, 0, 0)      -- 记录轮盘日志
        end

        player.m_wRouletteDoubleTimes = 2  -- 2次翻倍机会


        -- 发送消息给客户端
        for i=1,7 do
            local wheelMulti = GetExcelValue(TBWheelExcel,i,"multi")
            sendCmd.reward_gold_num:append(wheelMulti)
        end

        sendCmd.drop_num = rType
        sendCmd.gold_num = gold_reward
        LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_GAME_WHEELPLATE, sendCmd, nil,nil)       -- 发送轮盘中奖



        -- 如果中星星， 那么给大奖池
        if rType == ROULETTE_TYPE_STAR then
            --local gold_rewaed = JackpotGet(gameTable)      -- 大奖池
            --local l_get_Gold_reward = gold_rewaed * gameTable.RoomScore


            -- 发送客户端消息 ，大奖池收获
            local sendCmd = CMD_Game_TB_pb.CMD_S_PUBLIC_BIG_POOL()
            sendCmd.name = player.User.NickName
            sendCmd.id = player.User.UserId
            sendCmd.score = JackpotGet(gameTable)      -- 大奖池
            LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_PUBLIC_BIG_POOL, sendCmd, nil,nil)       -- 同步大奖池
        end
    else
        print("轮盘没有开启")
    end
end



----------------------------------------------------------------------------------------------
--- 轮盘双倍协议
----------------------------------------------------------------------------------------------



---------------------------------------------主协议入口-----------------------------------------------------
-- 客户端轮盘双倍请求
function HandleGameWheelDouble(userId,data)
    local player,game, gameTable = GetPlayer_Game_Table(userId)

    local l_DoubleReward = WheelGetGoldReward(player)       -- 上次的奖励
    local l_tiger = 0

    local msg = CMD_Game_TB_pb.CMD_C_GAME_SELECT_DOUBLE()
    msg:ParseFromString(data)

    local sendCmd = CMD_Game_TB_pb.CMD_S_GAME_SELECT_DOUBLE()
    --sendCmd.name = player.User.NickName

    --print("次数".. WheelGetDoubleTimes(player))
    --print("奖励".. WheelGetGoldReward(player))

    local doubleColor = msg.double_color    -- 客户端猜双倍的类型
    if doubleColor == ROULETTE_COLOR_CANCEL then
        -- 如果不参加猜红黑，直接加钱
        sendCmd = WheelCalcCreateCoin_Roulette(l_DoubleReward, player, sendCmd, player.m_eRouletteCurType)

        sendCmd.gold_num = l_DoubleReward
        sendCmd.tiger_reward_num = l_DoubleReward
        sendCmd.double_color = ROULETTE_COLOR_CANCEL

        LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_GAME_WHEEL_DOUBLE, sendCmd, nil,nil)
        WheelClearGoldReward(player)   --//奖励置零

        -- 保存玩家信息
        RedisSavePlayerAll(player.User)


        SqlSaveUserWheelLog(player,"不猜了", l_DoubleReward, sendCmd.big_coin_data.big_coin_lottery_value)      -- 记录玩家轮盘日志
        SqlSaveSystemLogWheel(gameTable , "不猜了", l_DoubleReward , player.User.UserId)        -- 记录轮盘流水
        return
    end


    if WheelGetDoubleTimes(player) <= 0 or WheelGetGoldReward( player) == 0 then
        -- 次数不足，或者没有中奖
        --print("次数不足，或者没有中奖")
        sendCmd.double_color = ROULETTE_COLOR_WRONG
        LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_GAME_WHEEL_DOUBLE, sendCmd, nil,nil)
        return
    else
        WheelReduceDoubleTimes(player) -- 减少次数

        if ZRandomMillionRate( WheelDoubleRate[WheelGetDoubleTimes(player)+1] ) then
            --中奖
            if WheelGetDoubleTimes(player) == 1 then
                 -- 第一次猜中 ， 奖励加倍
                --print("第一次猜中")
                WheelAddGoldReward(player,l_DoubleReward)
                SqlSaveUserWheelLog(player,"第一次翻倍猜中了", 0, 0)      -- 记录轮盘日志
                SqlSaveSystemLogWheel(gameTable , "第一次翻倍猜中了", l_DoubleReward , player.User.UserId)        -- 记录轮盘流水

            elseif WheelGetDoubleTimes(player) == 0 then
                -- 第二次猜中，直接加钱
                --print("第二次猜中")
                WheelAddGoldReward(player,l_DoubleReward)
                l_DoubleReward = WheelGetGoldReward(player)     -- 更新奖励
                sendCmd = WheelCalcCreateCoin_Roulette(l_DoubleReward, player, sendCmd, player.m_eRouletteCurType)

                sendCmd.gold_num = l_DoubleReward
                sendCmd.tiger_reward_num = l_tiger
                WheelClearDoubleTimes(player)     -- 清理次数
                WheelClearGoldReward(player)       -- 清理奖励

                SqlSaveUserWheelLog(player,"第二次翻倍猜中了", l_DoubleReward, sendCmd.big_coin_data.big_coin_lottery_value)      -- 记录轮盘日志
                SqlSaveSystemLogWheel(gameTable , "第二次翻倍猜中了", l_DoubleReward , player.User.UserId)        -- 记录轮盘流水
            end
        else
            --print("没有猜中")
            -- 没中奖，就改一下颜色
            doubleColor = math.abs(doubleColor - 1)
            --player.m_wRouletteDoubleTimes = player.m_wRouletteDoubleTimes - 1

            sendCmd.gold_num = 0
            sendCmd.tiger_reward_num = 0
            sendCmd.big_coin_data.big_coin_uid = 0
            sendCmd.big_coin_data.big_coin_value = 0

            WheelClearDoubleTimes(player)     -- 清理次数
            WheelClearGoldReward(player)    -- 清理奖励
            SqlSaveUserWheelLog(player,"没猜中", 0, 0)      -- 记录轮盘日志
            SqlSaveSystemLogWheel(gameTable , "没猜中", 0 , player.User.UserId)        -- 记录轮盘流水
        end


        --随一个数字结果 单数是红色 星星双数是黑色，给客户端显示用
        if doubleColor == ROULETTE_COLOR_BLACK then
            sendCmd.drop_num = GetRandom(0,3) * 2       -- 0 2 4 6
        else
            sendCmd.drop_num = GetRandom(0,3) * 2  + 1     -- 1 3 5 7
        end
        sendCmd.double_color = doubleColor

        LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_GAME_WHEEL_DOUBLE, sendCmd, nil,nil)

    end


    -- 保存玩家信息
    RedisSavePlayerAll(player.User)


end


