---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by soonyo.
--- DateTime: 2019/4/16 14:35
---

--------------------------------------------------------------------------------------
--- 老虎机的协议
--------------------------------------------------------------------------------------



function HandleGameTiger(userId, data)
    local player, game, gameTable = GetPlayer_Game_Table(userId)

    local msg = CMD_Game_TB_pb.CMD_C_GAME_TIGER()
    msg:ParseFromString(data)

    -- 检查投币数量
    --if player.m_mapUserTigerLastTriggerCoinNum < 1 then
    --    LuaNetWorkSendToUser(userId, MDM_GF_GAME_TB, SUB_C_GAME_TIGER, nil, userId .. "投币数量不足" .. player.m_mapUserTigerLastTriggerCoinNum, nil)
    --    return
    --end

    -- 判断触发间隔
    --local m_dwTigerCD = 1000;
    --local llCurrTime = GetOsTimeMillisecond()
    --if llCurrTime - player.m_mapUserTigerLastTimeStamp <= m_dwTigerCD then
    --    LuaNetWorkSendToUser(userId, MDM_GF_GAME_TB, SUB_C_GAME_CARD, nil, userId .. "间隔时间太短" .. player.m_mapUserPokerLastTimeStamp, nil)
    --    return
    --end

    local sendCmd = CMD_Game_TB_pb.CMD_S_GAME_TIGER()
    sendCmd.tiger_num = msg.tiger_num         -- 客户端发过来的


    --local tigerNum = msg.tiger_num  -- 客户端传过来的触发几个老虎机
    local bWin = false
    local bRou = false
    local bMultiSlot = false
    local iGoldNum = 0      --奖励金币数量
    local iTigerNum = 0     -- 本次老虎机本身奖励
    local iTicketNum = 0            --奖励奖券数量
    local iMultiValue = 1
    local bigCoinType = BIG_COIN_TYPE_NONE         -- 大金币类型
    local tigerType1 = TIGER_TYPE_APPLE
    local tigerType2 = TIGER_TYPE_APPLE
    local tigerType3 = TIGER_TYPE_APPLE


    --local m_dwTigerTriggerLimitNum =  GetExcelValue(TBCommonExcel,gameTable.RoomScore  , "slot_start_number")
    --if  player.m_mapUserTigerTriggerTimes >= m_dwTigerTriggerLimitNum then
    --    player:AddConfineUser()
    --    print("强制不中老虎机"..userId)
    --    iWinRate = 0
    --end

    --更新时间戳和触发计数
    player.m_mapUserTigerLastTimeStamp = GetOsTimeMillisecond()
    player.m_mapUserTigerTriggerTimes = player.m_mapUserTigerTriggerTimes + 1

    -- 减少触发的金币数量
    if player.m_mapUserTigerLastTriggerCoinNum >= 1 then
        player.m_mapUserTigerLastTriggerCoinNum = player.m_mapUserTigerLastTriggerCoinNum - 1
    end

    --local iRand = GetRandom(1, 10000)

    local iWinRate = TigerGetWinPro(player)  --  获取中奖几率


    if player.m_mapUserTigerLastTriggerCoinNum < 1 then
        iWinRate = ""               -- 如果投币数量小于1， 强制不中奖
    end



    if iWinRate == "WheelBingo" then
        -- 触发轮盘
        tigerType1 = TIGER_TYPE_ROU
        tigerType2 = TIGER_TYPE_ROU
        tigerType3 = TIGER_TYPE_ROU

        -- 开启轮盘的标识
        player.WheelOpen = 1       -- 轮盘开启标识

        sendCmd.result_type = 1          -- 1表示赢， 中奖

        SqlSaveUserTigerLog(player,TIGER_TYPE_ROU,0,0)      -- 玩家老虎机中奖日志

    elseif iWinRate == "TigerBingo" then
        -- 触发老虎机
        local tigerType = TIGER_TYPE_APPLE
        tigerType, iGoldNum = TigerCalcWinTypePro(player) --计算中奖类型

        bigCoinType = tigerType + BIG_COIN_TYPE_APPLE

        player.m_llTigerLastAward = iGoldNum
        tigerType1 = tigerType
        tigerType2 = tigerType
        tigerType3 = tigerType

        -- 是否中翻倍老虎机
        iGoldNum , iMultiValue = TigerDoublePlayerBingo(player, tigerType, iGoldNum)

        -- 记录日志在下面的发奖里面

        sendCmd.result_type = 1          -- 1表示赢， 中奖
    else
        -- 老虎机不中
        iGoldNum = 0
        tigerType1 = GetRandom(0, TIGER_TYPE_MAX - 1)
        tigerType2 = GetRandom(0, TIGER_TYPE_MAX - 1)
        tigerType3 = GetRandom(0, TIGER_TYPE_MAX - 1)

        --百分之20概率使 12相同 3不一样  客户端触发"机会"特效
        if ZRandomPercentRate(20) then
            tigerType1 = tigerType2
        end
        -- 保证三个不一样
        if tigerType1 == tigerType2 and tigerType1 == tigerType3 then
            tigerType3 = (tigerType1 + GetRandom(1, 5) % 3 + 1) % TIGER_TYPE_MAX
        end

        sendCmd.result_type = 0          -- 0 表示没有中奖
    end


    --Logger("老虎机， 随机 [1] " ..tigerType1.." [2] "..tigerType1.." [3] "..tigerType3)
    --if tigerType3 == 9 then
    --    Logger("老虎机 type3" ..tigerType3)
    --end


    -- 发送数据协议
    sendCmd = CalcCreateCoin_Tiger(iGoldNum, player, sendCmd, bigCoinType)      -- 计算是发小金币，还是大金币

    sendCmd.gold_num = iGoldNum     --奖励金币数量
    sendCmd.tiger_reward_num = iTigerNum  -- 本次老虎机本身奖励
    sendCmd.ticket_num = iTicketNum     --奖励奖券数量
    sendCmd.item_array:append(tigerType1)
    sendCmd.item_array:append(tigerType2)
    sendCmd.item_array:append(tigerType3)
    sendCmd.multi_value = iMultiValue     -- 这里以后要增加翻倍老虎机的判断， 普通是一倍


    LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_GAME_TIGER, sendCmd, nil, nil)


    -- 保存玩家信息
    RedisSavePlayerAll(player.User)




end