---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by soonyo.
--- DateTime: 2019/4/19 11:29
---

--------------------------------------------------------------------------------------
--- 热血模式的协议
--------------------------------------------------------------------------------------




---------------------------------------------主协议入口-----------------------------------------------------
-- 热血模式进入
function HandleGameBlood(userId,data)
    local player,game, gameTable = GetPlayer_Game_Table(userId)

    local msg = CMD_Game_TB_pb.CMD_C_B_MODE()
    msg:ParseFromString(data)
    local enterType = msg.enter_type
    --print("进入类型 ".. enterType)

    local sendCmd = CMD_Game_TB_pb.CMD_S_B_MODE()

    -- 热血模式是否开启
    player.BloodOpen = 1        --调试模式
    if player.BloodOpen <= 0 then
        print("热血模式没开启.....................")
        LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_BLOOD_MODE, nil, "热血模式没开启",nil)
        return
    end



    if enterType == BM_START then
        -- 第一次进入，计算一次
        sendCmd.result_type = BME_START_SUC
        for i=1,3 do
            sendCmd.time:append(GetExcelValue(TBBloodExcel,i,"time"))       -- 把时间
            sendCmd.condition_num:append(GetExcelValue(TBBloodExcel,i,"condition")) -- 把过关条件发给客户端
        end
        --print("随机开门")
        -- 开始随机
        local rand = GetRandom(1,10000)
        for i=1,2 do
            local rate = GetExcelValue(TBBloodExcel,i,"rate")
            if rand < rate then
                sendCmd.open_door:append(1)     -- 开门
                player.BloodModeOpenDoor[i] = 1
            else
                sendCmd.open_door:append(0)     -- 不开门
                player.BloodModeOpenDoor[i] = 0     -- 保存一下，发奖是否检测用
            end
        end
        --print(MySerpent.block(sendCmd))
        LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_BLOOD_MODE, sendCmd, nil,nil)
    else
        LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_BLOOD_MODE, nil, "热血模式类型不对",nil)
    end


end




--------------------------------------------------------------------------------------
--- 热血模式金币穿过的协议
--------------------------------------------------------------------------------------






---------------------------------------------主协议入口-----------------------------------------------------
-- 热血模式金币穿过
function HandleGameBloodPass(userId,data)
    local player,game, gameTable = GetPlayer_Game_Table(userId)

    local msg = CMD_Game_TB_pb.CMD_C_B_MODE_COIN_PASS()
    msg:ParseFromString(data)
    --local enterType = msg.num
    --for i,v in ipairs(msg.num) do
    --    print("i "..i.. " 得到金币".. v)
    --end


    -- 是热血模式
    if player.BloodOpen <= 0 then
        print("热血模式没有开启")
        LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_BLOOD_MODE_GOLD_PASS, nil, "热血模式没开启",nil)
        return
    end


    local sendCmd = CMD_Game_TB_pb.CMD_S_B_MODE_COIN_PASS()

    local allRewardCoin = 0   -- 获得的所有金币数量
    -- 循环客户端发来的数组
    for i, gold in ipairs(msg.num) do
        local condition = GetExcelValue(TBBloodExcel, i, "condition")
        local goldGet = gold * 2                 -- GetExcelValue(TBBloodExcel, i, "gold")

        allRewardCoin = allRewardCoin + goldGet   -- 把奖励累加起来

        if gold < condition then            -- 过关条件不满足
            if i>1 and player.BloodModeOpenDoor[i-1] == 0 then      -- 并且推开门还是失败的
                --print("热血模式过关条件不满足")
                --LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_BLOOD_MODE_GOLD_PASS, nil, "热血模式过关条件不满足",nil)
                --return
                break
            end
        end
    end

    --关闭热血模式
    player.BloodOpen =  0

    -- 发奖励allRewardGold
    sendCmd.gold_num = 0            -- 不加小金币， 只加大金币
    --sendCmd.coin_data:append(0)
    sendCmd = CoinCreateNewBigGold(allRewardCoin, player, sendCmd, BIG_COIN_TYPE_BLOOD)     -- 增加大金币


    --print("记录日志"..sendCmd.big_coin_data.big_coin_lottery_value)
    SqlSaveUserBloodModeLog(player  , "过了"..#msg.num.."关", allRewardCoin,  sendCmd.big_coin_data.big_coin_lottery_value)   -- 记录玩家热血模式的日志
    SqlSaveSystemLogBlood(gameTable , "过了"..#msg.num.."关" , allRewardCoin , player.User.UserId)     -- 记录热血模式日志


    --print("发送消息")
    LuaNetWorkSendToUser(player.User.UserId , MDM_GF_GAME_TB, SUB_S_BLOOD_MODE_GOLD_PASS, sendCmd, nil,nil)


    --print("保存玩家信息")
    RedisSavePlayerAll(player.User)

    --print("热血模式结束")

end

