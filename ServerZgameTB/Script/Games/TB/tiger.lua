---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by soonyo.
--- DateTime: 2019/4/20 17:40
---

-------------------------------------------------------------------------------
--- 老虎机    有可能掉小金币，有可能掉大金币 ， 小金币从侧门出
-------------------------------------------------------------------------------



--------------------------获取老虎机中奖几率-----------------------------------
-- 中奖几率
function TigerGetWinPro(player)

    local gameTable = player:GetTable()

    -- 中奖初始几率
    local wheelWin = TigerWheelOpenRate    --  轮盘中奖率 0.03,
    local tigerWin = TigerBingoRate  --    其他中奖率，0.09 % ，  不中奖率，0.88%

    -- 玩家的校验
    if  player.m_mapUserTigerTriggerTimes >= 30 then
        player:AddConfineUser()
        print("强制不中老虎机"..player.User.UserId)
        return nil
    end


    -- 库存的影响
    local fAdjustAll = PoolAllRate(player)

    -- 个人库存的影响
    local fAdjustPerson = PoolPersonRate(player)


    ---- 黑名单改变几率
    --local cbConfineLevel = player.User.ConfineLevel
    --if cbConfineLevel > 0 then
    --    local tiger_adjust =  GetExcelValue(TBConfineExcel, gameTable.RoomScore  , "tiger_adjust")
    --    fAdjust = fAdjust * tiger_adjust / 10000
    --end

    wheelWin = wheelWin * fAdjustAll * fAdjustPerson / 10000  / 10000
    --print("轮盘的中奖几率为：",wheelWin)
    tigerWin = tigerWin * fAdjustAll * fAdjustPerson / 10000  / 10000
    --print("老虎机的中奖几率为：",tigerWin)

    local rand = GetRandom(1,10000)

    -- 调试触发几率
    if 50 < GetRandom(0,100) then
        rand = tigerWin --调试
    end
    --rand = wheelWin --调试


    if rand <= wheelWin then
        return "WheelBingo"
    elseif rand <= tigerWin then
        return  "TigerBingo"
    end

    return  nil   -- 没有中奖
end






-- 计算是那种类型的中奖
function TigerCalcWinTypePro(player)
    --local gameTable = player:GetTable()

    local rand = GetRandom(1,10000)
    for index =1,8 do
        local rate = GetExcelValue(TBTigerExcel, index,"rate")
        if rand <= rate then
            -- 中了该类型
            local tigerType = GetExcelValue(TBTigerExcel, index,"result")
            local multi = GetExcelValue(TBTigerExcel, index,"multi")
            return tigerType,multi
        end
    end
    print("老虎机中奖几率出问题----------------------")
    return TIGER_TYPE_APPLE, 2
end





-- 老虎机获得金币， 有几率获得大金币， 或者小金币
function CalcCreateCoin_Tiger(coinNumber, player, sendCmd, bigCoinType)
    if coinNumber <= 0 then
        return sendCmd
    end
    --local gameTable = player:GetTable()
    local tigerType = bigCoinType - BIG_COIN_TYPE_APPLE

    --- 增加竞技赛积分，以后增加

    if ZRandomPercentRate(25) then
        -- 百分之25几率出大金币

        sendCmd = CoinCreateNewBigGold(coinNumber, player, sendCmd, bigCoinType)

        SqlSaveUserTigerLog(player,tigerType,coinNumber,  sendCmd.big_coin_data.big_coin_lottery_value )       -- 玩家老虎机日志

        local gameTable = player:GetTable()
        SqlSaveSystemLogTiger(gameTable , tigerType, coinNumber , player.User.UserId)            -- 老虎机流水日志

    else
        -- 小金币 + 奖券
        local lottery_value = 0
        sendCmd , lottery_value = CoinCreateNewGold(sendCmd, coinNumber, player)

        SqlSaveUserTigerLog(player,tigerType,coinNumber,  lottery_value  )       -- 玩家老虎机日志
        SqlSaveSystemLogTiger(gameTable , tigerType, coinNumber , player.User.UserId)            -- 老虎机流水日志
    end

    return sendCmd
end
