---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by soonyo.
--- DateTime: 2019/5/31 16:13
---


------------------------------------------------------------------------------------------------------
---老虎机翻倍
------------------------------------------------------------------------------------------------------


-- 老虎机翻倍池子增加
function TigerDoublePoolAdd(player, Score)
    local gameTable = player:GetTable()
    -- 老虎机翻倍的注入比率
    local dValue = Score * GetExcelValue(TBRoomExcel,gameTable.RoomScore,"tiger_ratio") /10000
    gameTable.TigerDoublePool = gameTable.TigerDoublePool + dValue
end

-- 老虎机翻倍开始的时候随机设置一下参数
function TigerDoublePoolStart(gameTable)
    print("老虎机翻倍开始的时候随机设置一下参数")

    gameTable.TigerDoublePool = 0       -- 清理一下判断是否开启的池子
    gameTable.TigerDoubleState = TIGER_DOUBLE_MS_INIT
    local rand = GetRandom(1,10000)
    --print("rand"..rand)
    for index =1,8 do
        local rate = GetExcelValue(TBTigerExcel, index,"odds")
        if rand <= rate then
            -- 中了该类型
            local multiple_min = GetExcelValue(TBTigerExcel, index,"multiple_min")
            local multiple_max = GetExcelValue(TBTigerExcel, index,"multiple_max")

            gameTable.TigerDoubleType = GetExcelValue(TBTigerExcel, index,"result")
            gameTable.TigerDoubleRate = GetRandom(multiple_min,multiple_max)          -- 随机出来翻倍倍率
            gameTable.TigerDoubleTimeDuring = GetExcelValue(TBTigerExcel, index,"time")
            return
        end
    end
end

-- 每隔一段时间检查是否达到触发翻倍的情况，如果触发开始计时
function TigerDoubleCheckOpen(gameTable)
    if gameTable.TigerDoubleState == TIGER_DOUBLE_MS_OPEN then
        -- 如果活动已经开启, 判断活动是否到时间而结束
        if GetOsTimeMillisecond() > gameTable.TigerDoubleTimeStart + gameTable.TigerDoubleTimeDuring * 1000     then
            -- 过期了，活动结束
            print("老虎机翻倍活动结束了，过时间了")
            gameTable.TigerDoubleState = TIGER_DOUBLE_MS_CLOSE
            TigerDoubleSendMsgToAllPlayer(gameTable,  "", gameTable.TigerDoubleRate * gameTable.RoomScore , 0)
            TigerDoublePoolStart(gameTable)     -- 重新随机下一轮
        end
    end

    -- 如果活动没有开启，且已经初始化了， 那么判断是否可以开启
    if gameTable.TigerDoubleState == TIGER_DOUBLE_MS_INIT then
        if gameTable.TigerDoublePool >= (gameTable.TigerDoubleRate - 1) * gameTable.RoomScore then
            print("满足老虎机双倍条件，开启双倍活动")
            gameTable.TigerDoubleState = TIGER_DOUBLE_MS_OPEN
            gameTable.TigerDoubleTimeStart = GetOsTimeMillisecond()         -- 开始时间
            -- 给所有玩家推送消息， 翻倍活动开始了
            TigerDoubleSendMsgToAllPlayer(gameTable,  "", gameTable.TigerDoubleRate * gameTable.RoomScore , 0)
        end
    end
end

-- 发消息给玩家
function TigerDoubleSendMsgToAllPlayer(gameTable,name,gold,id)
    for _,player in pairs(AllPlayerList) do
        if player.GameType ==  gameTable.GameID then
            -- 是同一个房间的玩家，那么推送
            local sendCmd = CMD_Game_TB_pb.CMD_S_MULTI_SLOT()
            sendCmd.mark = gameTable.TigerDoubleState
            sendCmd.multi_kind = gameTable.TigerDoubleType
            sendCmd.multi_value = gameTable.TigerDoubleRate
            sendCmd.remain_time = gameTable.TigerDoubleTimeDuring
            sendCmd.name = name
            sendCmd.gold = gold
            sendCmd.id = id
            LuaNetWorkSendToUser(player.User.UserId, MDM_GF_GAME_TB, SUB_S_MULTI_SLOT, sendCmd, nil, nil)
        end
    end
end

-- 检查玩家是否中奖翻倍
function TigerDoublePlayerBingo(player, tigerType,iGoldNum)
    local gameTable = player:GetTable()
    if gameTable.TigerDoubleState == TIGER_DOUBLE_MS_OPEN then
        -- 活动开启，并且玩家中奖
        if tigerType ==  gameTable.TigerDoubleType then
            -- 中奖相同
            gameTable.TigerDoubleState = TIGER_DOUBLE_MS_CLOSE
            TigerDoublePoolStart(gameTable)     -- 重新随机下一轮
            TigerDoubleSendMsgToAllPlayer(gameTable,  player.User.NickName, gameTable.TigerDoubleRate * gameTable.RoomScore , 0)

            return iGoldNum, gameTable.TigerDoubleRate      -- 如果中奖把倍率传递回去
        end
    end
    return iGoldNum,1
end