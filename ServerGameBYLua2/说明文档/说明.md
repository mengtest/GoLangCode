# goLua版本捕鱼的服务器程序



# 主逻辑架构

    主逻辑循环， 用来处理lua通用逻辑， 会创建lua堆栈进行主逻辑循环处理

    每一个玩家链接， 都会创建2个单独的goroutine，一个发送，一个接收，当有数据的时候会进行数据包的拆解， 数据包合法之后，会加锁传递给lua进行处理

	所以线程有很多，但是lua堆栈只有一个，业务逻辑都会在lua中执行，并且业务逻辑的执行是单线程顺序执行的（多线程调用也会加锁排队），所以业务逻辑开发者不用担心线程同步问题

# 目录结构

	Logs 生成日志的目录
	Script lua脚本目录
	GlobalVar 全局变量
	CSV 策划配置文件
	Lua lua交互部分，包括处理玩家连接的myserver
	NetWork 主要是发送socket，websocket网络处理
	Utils 包括日志，redis，mongodb，随机，计时器
	main  入口点


# 支持Socket,webSocket单独或者同时开启

# 数据库支持redis，mongodb

# 数据包支持错误提示，方便调试


---


### 句柄

	/***
	go服务器 掌握 GameManagerLua  lua逻辑处理
	go服务器 掌握 LuaConnectMyServer 这里有所有玩家的连接
				luaUIDConnectMyServer 这是玩家连接跟uid的对应关系




	Lua部分：

	服务器管理器有所有game的句柄，AllGamesList
	服务器管理器有所有player的句柄，AllPlayerList
	

	Game 有所有Table的句柄， AllTableList
	

	Table 有所有坐下玩家的句柄，UserSeatArray
	Table 有所有鱼的句柄，FishArray
	Table 有所有子弹的句柄，BulletArray
	
	
	***/


# 登录服务器

	登录服务器的作用：
	生成玩家uid的UUID必须是所有人都是同步的，唯一的，统一的才行，不然会错乱


	保证玩家同时只能有一个终端在线，防止多开数据错乱
	进行账号的校验
	返回服务器列表

	登录服务器可以做成两种形式：
	第一种形式（推荐）
	1. 后台网站返回服务器列表， 因为服务器列表是在数据库中，后台进行管理，客户端通过http来获取服务器列表，然后客户端可以选择一个服务器进入
	2. 这样就不需要单独的登录服务器了，登录的校验做在业务逻辑里面，跟其他逻辑一样
	3. 防止多开通过在redis数据库中判断即可

	第二种形式(运维麻烦，而且出问题所有玩家都不能登录, 玩家同时涌入的时候容易出问题)：
	1. 单独的登录服务器，单独的校验，单独开启
	2. 客户端http获取这个登录服务器地址
	3. 防止多开还是要通过redis数据库进行判断


# 日志服务器

	方式一：
		单独弄日志服务器，所有游戏服务器通过mq跟日志服务器进行数据交互
	方式二：
		没有单独日志服务器，游戏服务器自己记录日志即可


# 游戏服务器
# 捕鱼逻辑（普通业务逻辑）

	这个很简单，单人游戏，多人游戏都可以，写业务逻辑的时候，找到桌子的循环入口，玩家数据接收，玩家数据发送即可， 支持群发

# 聊天

	一。 游戏内聊天
		桌子内聊天不影响，本来就是自身处理即可，跟桌子游戏时候发子弹同步一样道理
	
	二。 世界聊天
		这个不需要单独的聊天服务器，一个进程可以带几百人，这里也有两种做法：
		第一种，世界聊天是这几百人聊
	 	1.  世界聊天并不跨服，只在当前这个服的几百人之间为世界聊天
		2.  聊天数据可以写日志，不需要写数据库
	
		第二种，世界聊天是所有玩家都能看见，跨服的
		1. 这种需要把聊天内容写入redis数据库， 然后每个服务器定期从数据库中拉取数据，然后给所有玩家同步出去

	三。 私聊
		这个直接写入玩家的私聊redis数据库，有点像邮件的感觉。

# 工会联盟

	1. 联盟的数据都在redis里面，玩家进行操作的时候，才会读取，然后处理，再回写入redis，游戏服务器不保存联盟数据
	2. 注意多个玩家在进行redis存取的时候，是并发操作，要加锁
	3. 上面的适合联盟公告，联盟签到，联盟捐献，联盟申请，联盟加入
	4. 联盟多人玩法，其中有人建立房间， 然后给在线的联盟成员发邀请， 联盟成员接收邀请，加入这个房间。

	
# 好友系统（师徒，结婚都是类似的）

	好友推荐（系统根据在线的玩家推送），好友申请，好友通过，好友列表，全部都是玩家自己操作自己数据
	当通过好友之后，会操作好友的申请列表删除，好友的好友列表会增加自己，这时会操作别人数据，加锁
	
# 世界boss

	做法一：单独的服务器，所有参与活动的玩家登陆该服务器，进入桌子，参与战斗
	做法二：不是单独服务器，所有参与活动的玩家跟本服玩家进行游戏，最后成绩可以跨服，也可以不跨服，都是操作redis列表，加锁

# 排行榜

	竞技场排行，玩家参与活动之后，获得积分，操作redis排行数据，如果变化，回存

# 组队
	有人建立一个pk房间，其他玩家通过redis列表查看到，可以加入房间（ip，端口，房间号）

# pk
	有人建立一个pk房间，其他玩家通过redis列表查看到，可以加入房间（ip，端口，房间号）
	

# 跨服战

	
	做法一：单独跨服服务器， 所有参与活动的玩家登陆该服务器，该服务器进行匹配，匹配成功，进入战斗
	做法二：不是单独跨服服务器，参与活动的玩家有人建房间，房间有一个统一列表在redis里面，其他玩家进入该房间的ip，端口，房间号


# 联盟pk

	参与活动的玩家，有人建立一个pk房间，其他玩家通过redis列表查看到，可以加入房间（ip，端口，房间号）

# redis数据库

	BY_AllPlayers	全部的玩家数据
	BY_GameState:服务器IP:游戏:桌子	全部游戏桌子的状态
	BY_ServerState：服务器IP：日期：时间	全部服务器的状态

	Online_AllPlayers  全部在线的玩家数据	 key uid value ip:port


